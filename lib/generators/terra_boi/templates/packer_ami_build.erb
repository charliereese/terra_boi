#!/bin/bash

# Update to the latest current version of packages
sudo apt-get update
sudo apt -y install docker.io
docker --version

# Set DB and DockerHub usernames
RAILS_MASTER_KEY=`sudo cat /tmp/master.key`
sudo bash -c "echo 'RAILS_MASTER_KEY=$RAILS_MASTER_KEY' >> /etc/environment"
sudo bash -c "echo 'DB_PASSWORD=$DB_PASSWORD' >> /etc/environment"
sudo bash -c "echo 'DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME' >> /etc/environment"
sudo bash -c "echo 'AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID' >> /etc/environment"
sudo bash -c "echo 'AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY' >> /etc/environment"

# # Start the Docker service
sudo service docker start
sudo usermod -aG docker ubuntu

# # Automatically start Docker service when the system boots, i.e. when the EC2 instance created from this AMI is launched or rebooted
sudo systemctl enable docker

# Log in
sudo docker login --username $DOCKERHUB_USERNAME -p $DOCKERHUB_ACCESS_TOKEN

# Pull the container:
sudo docker pull $DOCKERHUB_USERNAME/<%= application_name %>:latest